---
title: "figure4"
format: html
---

```{r}
library("tidyverse")
library("ggrepel")
library("patchwork")
```

```{r}
clean_cells <- clean_2 |>
  select(
    gene    = 1,
    protein = 2,
    astro   = 3,
    micro   = 4,
    neuron  = 5,
    oligo   = 6
  ) |>
  slice(-(1:2))      


clean_cells <- clean_cells |>
  mutate(
    astro  = as.numeric(astro),
    micro  = as.numeric(micro),
    neuron = as.numeric(neuron),
    oligo  = as.numeric(oligo)
  )


astrocyte_markers <-c("Aqp4", "Gfap", "Glast", "Aldh1l1") |>
  toupper()

oligodendrocyte_markers <- c("Cnp1", "Sox10", "Mbp", "Mag", "Mog", "Plp1") |>
  toupper()

neuron_markers <-c("Snap25", "Tubb3", "Calb1", "Syt1") |>
  toupper()

microglia_markers <-c("Iba1", "Tlr2", "Tlr7", "CD86") |>
  toupper()



```

### Trying with the median

```{r}
panel_df <- clean_cells |>
  mutate(
    gene_up = gene |> toupper() |> str_trim(),

    logLFQ_astro  = astro,
    logLFQ_micro  = micro,
    logLFQ_neuron = neuron,
    logLFQ_oligo  = oligo
  ) |>
  rowwise() |>
  mutate(
    logLFQ_median = median(c_across(starts_with("logLFQ_")), na.rm = TRUE),
    logFC_astro   = logLFQ_astro  - logLFQ_median,
    logFC_micro   = logLFQ_micro  - logLFQ_median,
    logFC_neuron  = logLFQ_neuron - logLFQ_median,
    logFC_oligo   = logLFQ_oligo  - logLFQ_median
  ) |>
  ungroup()

```

```{}
```

### Plotting

```{r}
# Split dataset by cell type for plotting
astro_plot_df  <- all_df |> filter(type == "Astrocytes")
micro_plot_df  <- all_df |> filter(type == "Microglia")
neuron_plot_df <- all_df |> filter(type == "Neurons")
oligo_plot_df  <- all_df |> filter(type == "Oligodendrocytes")

# Select only marker genes for labelling in each panel
astro_labels <- astro_plot_df |>
  filter(gene_up %in% astrocyte_markers)

micro_labels <- micro_plot_df |>
  filter(gene_up %in% microglia_markers)

neuron_labels <- neuron_plot_df |>
  filter(gene_up %in% neuron_markers)

oligo_labels <- oligo_plot_df |>
  filter(gene_up %in% oligodendrocyte_markers)

draw_panel <- function(df_sub,
                       df_labels,
                       panel_title) {

  ggplot(df_sub,
         aes(x = logFC,
             y = logLFQ)) +

    # Add reference lines (median LFQ and zero FC)
    geom_hline(yintercept = median(df_sub$logLFQ, na.rm = TRUE),
               linetype   = "dashed",
               color      = "grey85",
               size       = 0.3) +
    geom_vline(xintercept = 0,
               linetype   = "dashed",
               color      = "grey85",
               size       = 0.3) +

    # Scatter points colored by marker category
    geom_point(aes(color = category),
               alpha = 0.55,
               size  = 1.4) +

    scale_color_manual(values = cols) +

    # Label ONLY the cell-type-specific marker genes for this panel
    geom_text_repel(
      data          = df_labels,
      aes(label     = gene),
      size          = 3.0,
      max.overlaps  = Inf,
      box.padding   = 0.3,
      segment.size  = 0.25,
      segment.alpha = 0.6
    ) +

    labs(
      title = panel_title,
      x     = "log2 fold expression (cell type vs median)",
      y     = "log2 LFQ intensity"
    ) +

    base_theme
}


astro_plot_df  <- all_df |> filter(type == "Astrocytes")
astro_labels   <- labels_df |> filter(type == "Astrocytes")

micro_plot_df  <- all_df |> filter(type == "Microglia")
micro_labels   <- labels_df |> filter(type == "Microglia")

neuron_plot_df <- all_df |> filter(type == "Neurons")
neuron_labels  <- labels_df |> filter(type == "Neurons")

oligo_plot_df  <- all_df |> filter(type == "Oligodendrocytes")
oligo_labels   <- labels_df |> filter(type == "Oligodendrocytes")


p_astro  <- draw_panel(astro_plot_df,  astro_labels,  "Astrocytes")
p_micro  <- draw_panel(micro_plot_df,  micro_labels,  "Microglia")
p_neuron <- draw_panel(neuron_plot_df, neuron_labels, "Neurons")
p_oligo  <- draw_panel(oligo_plot_df,  oligo_labels,  "Oligodendrocytes")

combined <- p_astro +
  p_micro +
  p_neuron +
  p_oligo +
  plot_layout(nrow = 2, guides = "collect") &
  theme(legend.position = "bottom")

ggsave(
  filename = "../results/Figure4_median_improved_2row.jpg",
  plot     = combined,
  width    = 18,
  height   = 5,
  dpi      = 300
)

combined
```
