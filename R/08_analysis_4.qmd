---
title: "figure4"
format: html
---

```{r}
library("tidyverse")
library("ggrepel")
library("patchwork")
```

```{r}
clean_cells <- clean_2 |>
  select(
    gene    = 1,
    protein = 2,
    astro   = 3,
    micro   = 4,
    neuron  = 5,
    oligo   = 6,
    brain   = 7  
  ) |>
  slice(-(1:2))      


clean_cells <- clean_cells |>
  mutate(
    astro  = as.numeric(astro),
    micro  = as.numeric(micro),
    neuron = as.numeric(neuron),
    oligo  = as.numeric(oligo),
    brain  = as.numeric(brain)
  )



myelin_genes <- c("Mbp", "Plp1", "Cnp", "Mag", "Mog") |>
  toupper()

cytoskeleton_genes <- c("Tuba1b", "Actb", "Sptan1", "Map1a", "Map2",
                        "Tubb3", "Nefm", "Nefl", "Map6", "Acta2") |>
  toupper()

synapse_genes <- c("Syn1", "Dnm1", "Camk2a", "Camk2b", "Syt1",
                   "Snap25", "Bsn", "Stx1b", "Syn2", "Snap91") |>
  toupper()


panel_df <- clean_cells |>
  mutate(
    gene_up = gene |>
      toupper() |>
      str_trim(),

    # log2 fold expression vs whole brain
    logFC_astro  = log2(astro  / brain),
    logFC_micro  = log2(micro  / brain),
    logFC_neuron = log2(neuron / brain),
    logFC_oligo  = log2(oligo  / brain),

    # LFQ values are already log2 in the dataset
    logLFQ_astro  = astro,
    logLFQ_micro  = micro,
    logLFQ_neuron = neuron,
    logLFQ_oligo  = oligo
  )


astro_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_astro,
         logLFQ = logLFQ_astro) |>
  mutate(type = "Astrocytes")

micro_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_micro,
         logLFQ = logLFQ_micro) |>
  mutate(type = "Microglia")

neuron_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_neuron,
         logLFQ = logLFQ_neuron) |>
  mutate(type = "Neurons")

oligo_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_oligo,
         logLFQ = logLFQ_oligo) |>
  mutate(type = "Oligodendrocytes")

all_df <- bind_rows(astro_df, micro_df, neuron_df, oligo_df)


all_df <- all_df |>
  mutate(
    category = case_when(
      gene_up %in% myelin_genes       ~ "Myelin",
      gene_up %in% cytoskeleton_genes ~ "Cytoskeleton",
      gene_up %in% synapse_genes      ~ "Synapse",
      TRUE                             ~ "Other"
    )
  )


all_df <- all_df |>
  filter(is.finite(logFC),
         is.finite(logLFQ))


labels_df <- all_df |>
  group_by(type) |>
  mutate(score = logLFQ * abs(logFC)) |>
  arrange(desc(score)) |>
  slice_head(n = 12) |>
  ungroup()


cols <- c(
  "Myelin"       = "#D7191C",
  "Cytoskeleton" = "#2B83BA",
  "Synapse"      = "#1A9850",
  "Other"        = "grey70"
)

base_theme <- theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey90"),
    strip.text       = element_text(size = 14, face = "bold"),
    plot.title       = element_text(size = 16, face = "bold"),
    axis.title       = element_text(size = 12)
  )


draw_panel <- function(df_sub,
                       df_labels,
                       panel_title) {

  ggplot(df_sub,
         aes(x = logFC,
             y = logLFQ)) +
    geom_hline(yintercept = median(df_sub$logLFQ, na.rm = TRUE),
               linetype   = "dashed",
               color      = "grey85",
               size       = 0.3) +
    geom_vline(xintercept = 0,
               linetype   = "dashed",
               color      = "grey85",
               size       = 0.3) +
    geom_point(aes(color = category),
               alpha = 0.55,
               size  = 1.4) +
    scale_color_manual(values = cols) +
    geom_text_repel(data        = df_labels,
                    aes(label   = gene),
                    size         = 3.0,
                    max.overlaps = 20,
                    box.padding  = 0.3,
                    segment.size = 0.25,
                    segment.alpha= 0.6) +
    labs(
      title = panel_title,
      x     = "log2 fold expression (cell type vs Brain)",
      y     = "log2 LFQ intensity"
    ) +
    base_theme
}

astro_plot_df  <- all_df |> filter(type == "Astrocytes")
astro_labels   <- labels_df |> filter(type == "Astrocytes")

micro_plot_df  <- all_df |> filter(type == "Microglia")
micro_labels   <- labels_df |> filter(type == "Microglia")

neuron_plot_df <- all_df |> filter(type == "Neurons")
neuron_labels  <- labels_df |> filter(type == "Neurons")

oligo_plot_df  <- all_df |> filter(type == "Oligodendrocytes")
oligo_labels   <- labels_df |> filter(type == "Oligodendrocytes")


p_astro  <- draw_panel(astro_plot_df,  astro_labels,  "Astrocytes")
p_micro  <- draw_panel(micro_plot_df,  micro_labels,  "Microglia")
p_neuron <- draw_panel(neuron_plot_df, neuron_labels, "Neurons")
p_oligo  <- draw_panel(oligo_plot_df,  oligo_labels,  "Oligodendrocytes")

combined <- p_astro +
  p_micro +
  p_neuron +
  p_oligo +
  plot_layout(nrow = 1, guides = "collect") &
  theme(legend.position = "bottom")

ggsave(
  filename = "../results/Figure4_4.jpg",
  plot     = combined,
  width    = 18,
  height   = 5,
  dpi      = 300
)

combined


```
