---
title: "Log2"
format: html
---

```{r}
library(tidyverse)
library(ggrepel)
library(patchwork)

astrocyte_markers       <- c("Aqp4", "Gfap", "Glast", "Aldh1l1") |> toupper()
oligodendrocyte_markers <- c("Cnp1", "Sox10", "Mbp", "Mag", "Mog", "Plp1") |> toupper()
neuron_markers          <- c("Snap25", "Tubb3", "Calb1", "Syt1") |> toupper()
microglia_markers       <- c("Iba1", "Tlr2", "Tlr7", "CD86") |> toupper()

clean_cells <- clean_2 |>
  select(
    gene    = 1,
    protein = 2,
    astro   = 3,
    micro   = 4,
    neuron  = 5,
    oligo   = 6
  ) |>
  slice(-(1:2)) |>   # remove repeated header rows if present
  mutate(
    astro  = as.numeric(astro),
    micro  = as.numeric(micro),
    neuron = as.numeric(neuron),
    oligo  = as.numeric(oligo)
  )


panel_df <- clean_cells |>
  mutate(
    # uppercase gene name for matching with marker lists
    gene_up = gene |> toupper() |> str_trim(),

    # explicitly name the logLFQ columns (they are already log2)
    logLFQ_astro  = astro,
    logLFQ_micro  = micro,
    logLFQ_neuron = neuron,
    logLFQ_oligo  = oligo
  ) |>
  # compute median across the 4 logLFQ columns per row (gene)
  rowwise() |>
  mutate(
    logLFQ_median = median(c_across(starts_with("logLFQ_")), na.rm = TRUE),

    # log fold changes relative to the median
    logFC_astro  = logLFQ_astro  - logLFQ_median,
    logFC_micro  = logLFQ_micro  - logLFQ_median,
    logFC_neuron = logLFQ_neuron - logLFQ_median,
    logFC_oligo  = logLFQ_oligo  - logLFQ_median
  ) |>
  ungroup()



astro_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_astro, logLFQ = logLFQ_astro) |>
  mutate(type = "Astrocytes")

micro_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_micro, logLFQ = logLFQ_micro) |>
  mutate(type = "Microglia")

neuron_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_neuron, logLFQ = logLFQ_neuron) |>
  mutate(type = "Neurons")

oligo_df <- panel_df |>
  select(gene, gene_up, protein, logFC = logFC_oligo, logLFQ = logLFQ_oligo) |>
  mutate(type = "Oligodendrocytes")

# combine
all_df <- bind_rows(astro_df, micro_df, neuron_df, oligo_df)


all_df <- all_df |>
  mutate(
    category = case_when(
      gene_up %in% astrocyte_markers       ~ "Astrocyte",
      gene_up %in% neuron_markers          ~ "Neuron",
      gene_up %in% microglia_markers       ~ "Microglia",
      gene_up %in% oligodendrocyte_markers ~ "Oligodendrocyte",
      TRUE                                  ~ "Other"
    )
  ) |>
  # keep only finite numeric rows for plotting
  filter(is.finite(logFC), is.finite(logLFQ))


astro_plot_df  <- all_df |> filter(type == "Astrocytes")
micro_plot_df  <- all_df |> filter(type == "Microglia")
neuron_plot_df <- all_df |> filter(type == "Neurons")
oligo_plot_df  <- all_df |> filter(type == "Oligodendrocytes")

# label dfs: only marker genes of the panel (no top-score filtering)
astro_labels  <- astro_plot_df  |> filter(gene_up %in% astrocyte_markers)
micro_labels  <- micro_plot_df  |> filter(gene_up %in% microglia_markers)
neuron_labels <- neuron_plot_df |> filter(gene_up %in% neuron_markers)
oligo_labels  <- oligo_plot_df  |> filter(gene_up %in% oligodendrocyte_markers)


cols <- c(
  "Oligodendrocyte" = "#D7191C",
  "Neuron"           = "#00008B",
  "Microglia"        = "#2B83BA",
  "Astrocyte"        = "#1A9850",
  "Other"            = "grey70"
)

base_theme <- theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "grey90"),
    strip.text       = element_text(size = 14, face = "bold"),
    plot.title       = element_text(size = 16, face = "bold"),
    axis.title       = element_text(size = 12)
  )


draw_panel <- function(df_sub, df_labels, panel_title) {
  ggplot(df_sub, aes(x = logFC, y = logLFQ)) +
    # reference lines
    geom_hline(yintercept = median(df_sub$logLFQ, na.rm = TRUE),
               linetype = "dashed", color = "grey85", size = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey85", size = 0.3) +
    # scatter points coloured by global category
    geom_point(aes(color = category), alpha = 0.55, size = 1.4) +
    scale_color_manual(values = cols) +
    # label ONLY the panel's marker genes (df_labels)
    geom_text_repel(
      data = df_labels,
      aes(label = gene),
      size = 3.0,
      max.overlaps = Inf,
      box.padding = 0.3,
      segment.size = 0.25,
      segment.alpha = 0.6
    ) +
    labs(
      title = panel_title,
      x = "log2 fold expression (cell type vs median)",
      y = "log2 LFQ intensity"
    ) +
    base_theme
}

p_astro  <- draw_panel(astro_plot_df,  astro_labels,  "Astrocytes")
p_micro  <- draw_panel(micro_plot_df,  micro_labels,  "Microglia")
p_neuron <- draw_panel(neuron_plot_df, neuron_labels, "Neurons")
p_oligo  <- draw_panel(oligo_plot_df,  oligo_labels,  "Oligodendrocytes")

combined <- p_astro + p_micro + p_neuron + p_oligo +
  plot_layout(nrow = 2, guides = "collect") & theme(legend.position = "bottom")

ggsave(
  filename = "../results/log2.jpg",
  plot = combined,
  width = 18,
  height = 10,
  dpi = 300
)

combined

```
