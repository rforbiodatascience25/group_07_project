---
title: "all"
format: html
editor: visual
---

# Introduction to the project

### Plotting the log2 change in gene expression across cell types

```{r}

all_df <- read_tsv("../data/augmented_data/table_2_log.tsv")

#Defining the markers that we use for each cell type
astro_markers       <- c("Aqp4", "Gfap", "Glast", "Aldh1l1")
micro_markers       <- c("Iba1", "Tlr2", "Tlr7", "CD86")
neuron_markers      <- c("Snap25", "Tubb3", "Calb1", "Syt1")
oligo_markers       <- c("Cnp1", "Sox10", "Mbp", "Mag", "Mog", "Plp1")

#Plotting
labels_df <- all_df |>
  group_by(type) |>
  filter(
    (type == "Astrocytes"       & gene %in% astro_markers)  |
    (type == "Microglia"        & gene %in% micro_markers)  |
    (type == "Neurons"          & gene %in% neuron_markers) |
    (type == "Oligodendrocytes" & gene %in% oligo_markers)
  ) |>
  ungroup()

cols <- c(
  "Astrocyte markers"       = "#1A9850",
  "Microglia markers"       = "#2B83BA",
  "Neuron markers"          = "#00008B",
  "Oligodendrocyte markers" = "#D7191C",
  "Other"                   = "grey70"
)

base_theme <- theme_bw(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.title = element_blank()
  )

draw_panel <- function(df_sub, df_labels, panel_title) {
  ggplot(df_sub, aes(x = logFC, y = logLFQ)) +
    geom_hline(yintercept = median(df_sub$logLFQ, na.rm = TRUE), linetype="dashed", color="grey80") +
    geom_vline(xintercept = 0, linetype="dashed", color="grey80") +
    geom_point(aes(color = category), alpha = 0.55) +
    scale_color_manual(values = cols) +
    geom_text_repel(data = df_labels, aes(label = gene), size = 3) +
    labs(
      title = panel_title,
      x = "log2 fold expression (cell type vs median)",
      y = "log2 LFQ intensity"
    ) +
    base_theme
}

p_astro  <- draw_panel(all_df |> filter(type == "Astrocytes"),       labels_df |> filter(type == "Astrocytes"),       "Astrocytes")
p_micro  <- draw_panel(all_df |> filter(type == "Microglia"),        labels_df |> filter(type == "Microglia"),        "Microglia")
p_neuron <- draw_panel(all_df |> filter(type == "Neurons"),          labels_df |> filter(type == "Neurons"),          "Neurons")
p_oligo  <- draw_panel(all_df |> filter(type == "Oligodendrocytes"), labels_df |> filter(type == "Oligodendrocytes"), "Oligodendrocytes")

combined <- p_astro + p_micro + p_neuron + p_oligo +
  plot_layout(nrow = 2, guides = "collect") &
  theme(legend.position = "bottom")

ggsave("../results/Figure4_final.jpg", combined, width = 18, height = 10, dpi = 300)
```
